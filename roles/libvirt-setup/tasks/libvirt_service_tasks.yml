---
- name: Workaround - disable libvirt security_driver
  become: true
  block:
    - ansible.builtin.lineinfile:
        path: /etc/libvirt/qemu.conf
        line: 'security_driver = "selinux"'
        state: absent
    - ansible.builtin.lineinfile:
        path: /etc/libvirt/qemu.conf
        line: 'security_driver = "apparmor"'
        state: absent
    - ansible.builtin.lineinfile:
        path: /etc/libvirt/qemu.conf
        line: 'security_driver = "none"'
  register: security_driver_config

- name: "Add the user {{ lookup('env','USER') }} to libvirt/kvm groups"
  become: true
  ansible.builtin.user:
    name: "{{ lookup('env','USER') }}"
    groups: libvirt,kvm
    append: true
  register: user_groups_config

- name: Restart libvirtd
  become: true
  ansible.builtin.service:
    name: libvirtd
    state: restarted
  when: security_driver_config.changed or user_groups_config.changed

- name: "Allow {{ lookup('env','USER') }} access to /var/run/libvirt/libvirt-sock"
  become: true
  ansible.posix.acl:
    path: /var/run/libvirt/libvirt-sock
    entity: "{{ lookup('env','USER') }}"
    etype: user
    permissions: rw
    state: present
